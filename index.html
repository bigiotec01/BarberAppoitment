<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barber Shop Pro | Bgio System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(24, 24, 27, 0.9); backdrop-filter: blur(15px); }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        .admin-scroll { overflow-y: auto; max-height: 55vh; }
    </style>
</head>
<body class="bg-black text-white min-h-screen font-sans overflow-x-hidden">

    <!-- ===== PANTALLA DE INICIO / AUTH ===== -->
    <div id="view-auth" class="max-w-md mx-auto px-8 flex flex-col items-center justify-center min-h-screen space-y-8">
        <header class="text-center w-full">
            <h1 class="text-5xl font-black italic uppercase text-white">Barber <span class="text-yellow-500">Shop</span></h1>
            <p class="text-zinc-500 text-[10px] tracking-[0.4em] mt-2 uppercase">Ismael Bigio Studio</p>
        </header>

        <!-- Formulario Login -->
        <div id="form-login" class="w-full space-y-4 fade-in">
            <input type="email" id="login-email" placeholder="Usuario (Email)"
                class="w-full bg-zinc-900 p-4 rounded-2xl outline-none border border-zinc-800 focus:border-yellow-500 transition-colors">
            <input type="password" id="login-pass" placeholder="Contraseña"
                class="w-full bg-zinc-900 p-4 rounded-2xl outline-none border border-zinc-800 focus:border-yellow-500 transition-colors">
            <button onclick="login()"
                class="w-full bg-yellow-500 text-black font-black py-4 rounded-2xl uppercase tracking-widest shadow-lg shadow-yellow-500/20 active:scale-95 transition-all">
                Entrar
            </button>
            <p class="text-center text-xs text-zinc-500">¿Nuevo cliente?
                <button onclick="toggleAuth('reg')" class="text-yellow-500 font-bold">Crear cuenta</button>
            </p>
        </div>

        <!-- Formulario Registro -->
        <div id="form-reg" class="hidden w-full space-y-4 fade-in">
            <div class="grid grid-cols-2 gap-2">
                <input type="text" id="reg-nom" placeholder="Nombre"
                    class="w-full bg-zinc-900 p-4 rounded-2xl outline-none border border-zinc-800 focus:border-yellow-500 transition-colors">
                <input type="text" id="reg-ape" placeholder="Apellido"
                    class="w-full bg-zinc-900 p-4 rounded-2xl outline-none border border-zinc-800 focus:border-yellow-500 transition-colors">
            </div>
            <input type="tel" id="reg-tel" placeholder="WhatsApp"
                class="w-full bg-zinc-900 p-4 rounded-2xl outline-none border border-zinc-800 focus:border-yellow-500 transition-colors">
            <input type="email" id="reg-email" placeholder="Email"
                class="w-full bg-zinc-900 p-4 rounded-2xl outline-none border border-zinc-800 focus:border-yellow-500 transition-colors">
            <input type="password" id="reg-pass" placeholder="Contraseña (6+ caracteres)"
                class="w-full bg-zinc-900 p-4 rounded-2xl outline-none border border-zinc-800 focus:border-yellow-500 transition-colors">
            <button onclick="registrar()"
                class="w-full bg-white text-black font-black py-4 rounded-2xl uppercase tracking-widest active:scale-95 transition-all">
                Registrarme
            </button>
            <p class="text-center text-xs text-zinc-500">¿Ya tienes cuenta?
                <button onclick="toggleAuth('login')" class="text-yellow-500 font-bold">Entrar</button>
            </p>
        </div>
    </div>

    <!-- ===== PANTALLA PRINCIPAL APP ===== -->
    <div id="view-app" class="hidden max-w-md mx-auto p-6 pb-32 fade-in">
        <header class="flex justify-between items-center py-6">
            <div>
                <p class="text-[10px] text-zinc-500 uppercase font-bold tracking-widest">Hola,</p>
                <h3 id="user-display-name" class="text-xl font-black text-white italic uppercase">...</h3>
            </div>
            <button onclick="logout()" class="text-[10px] bg-zinc-900 px-4 py-2 rounded-xl text-zinc-500 font-bold">SALIR</button>
        </header>

        <!-- Paso 1: Elegir fecha -->
        <section id="step-1" class="space-y-8 text-center py-4 fade-in">
            <div class="bg-zinc-900/50 p-8 rounded-[2.5rem] border border-zinc-800 shadow-2xl">
                <h2 class="text-xl font-bold mb-6 italic">¿Qué día quieres venir?</h2>
                <input type="date" id="fecha" onchange="irAlPaso(2)"
                    class="w-full bg-black border-2 border-zinc-800 p-5 rounded-3xl text-xl text-center text-white outline-none focus:border-yellow-500 transition-all">
            </div>
        </section>

        <!-- Paso 2: Elegir hora -->
        <section id="step-2" class="hidden space-y-6 fade-in">
            <div class="flex items-center gap-4">
                <button onclick="irAlPaso(1)" class="p-3 rounded-full bg-zinc-900 text-zinc-400 hover:bg-zinc-800 transition-colors">←</button>
                <h2 class="text-2xl font-black italic uppercase">Horas Libres</h2>
            </div>
            <div id="grid-horarios" class="grid grid-cols-3 gap-3"></div>
        </section>

        <!-- Paso 3: Confirmación -->
        <section id="step-success" class="hidden text-center py-10 space-y-6 fade-in">
            <div class="text-7xl">✅</div>
            <h2 class="text-3xl font-black italic uppercase">¡Cita Confirmada!</h2>
            <div id="resumen-final" class="bg-zinc-900 p-6 rounded-3xl border border-zinc-800 text-yellow-500 font-black text-xl"></div>
            <button onclick="location.reload()" class="bg-white text-black px-8 py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Entendido</button>
        </section>
    </div>

    <!-- ===== FOOTER FIJO ===== -->
    <footer class="fixed bottom-0 left-0 right-0 p-4 text-center bg-black/80 backdrop-blur-md border-t border-zinc-900 z-40">
        <p class="text-zinc-600 text-[10px] font-bold uppercase tracking-widest">© 2026 Bgio System | v2.1.0</p>
    </footer>

    <!-- ===== BOTONES FLOTANTES ===== -->
    <div id="float-btns" class="hidden fixed bottom-14 left-0 right-0 flex justify-center gap-6 px-6 pointer-events-none z-50">
        <button onclick="toggleQR()" class="pointer-events-auto bg-white text-black p-5 rounded-full shadow-2xl active:scale-90 transition-all" title="Compartir QR">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2"/>
            </svg>
        </button>
        <button onclick="accesoAdmin()" class="pointer-events-auto bg-zinc-800 text-white p-5 rounded-full shadow-2xl active:scale-90 transition-all" title="Panel Admin">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
        </button>
    </div>

    <!-- ===== MODAL QR ===== -->
    <div id="qrModal" class="hidden fixed inset-0 glass flex items-center justify-center p-8 z-[100]">
        <div class="bg-zinc-900 p-10 rounded-[3rem] text-center border border-zinc-800 w-full shadow-2xl">
            <p class="text-xs text-zinc-500 mb-4 uppercase tracking-widest">Comparte tu link de reserva</p>
            <div id="qrcode" class="bg-white p-6 rounded-[2rem] inline-block mb-8"></div>
            <button onclick="toggleQR()" class="w-full bg-zinc-800 py-5 rounded-2xl font-black text-white">Cerrar</button>
        </div>
    </div>

    <!-- ===== MODAL ADMIN ===== -->
    <div id="adminModal" class="hidden fixed inset-0 glass flex items-center justify-center p-6 z-[100]">
        <div class="bg-zinc-900 p-6 rounded-[2.5rem] border border-zinc-800 w-full max-w-md shadow-2xl flex flex-col" style="max-height:85vh;">
            <div class="flex justify-between items-center mb-5">
                <div>
                    <h2 class="text-xl font-black italic uppercase text-yellow-500">Panel Admin</h2>
                    <p class="text-zinc-600 text-[10px] tracking-widest uppercase mt-0.5">Gestión de citas</p>
                </div>
                <button onclick="toggleAdmin()" class="text-zinc-400 text-xs bg-zinc-800 px-4 py-2 rounded-xl font-bold hover:bg-zinc-700 transition-colors">Cerrar</button>
            </div>

            <!-- Contador de citas -->
            <div id="admin-stats" class="bg-zinc-800/50 rounded-2xl p-4 mb-4 text-center">
                <p id="admin-total" class="text-yellow-500 font-black text-2xl">—</p>
                <p class="text-zinc-500 text-[10px] uppercase tracking-widest">Citas totales</p>
            </div>

            <!-- Lista de citas -->
            <div id="admin-citas" class="admin-scroll space-y-3 flex-1"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDYfOXjZ0j426OEBgAttrBvMCAbmDPKFSE",
            authDomain: "babershop-fa82a.firebaseapp.com",
            projectId: "babershop-fa82a",
            storageBucket: "babershop-fa82a.firebasestorage.app",
            messagingSenderId: "630094758977",
            appId: "1:630094758977:web:a62f2dbccd085ef8c732c0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const horasBase = ["09:00 AM","10:00 AM","11:00 AM","12:00 PM","01:00 PM","02:00 PM","03:00 PM","04:00 PM","05:00 PM","06:00 PM","07:00 PM"];
        let userData = null;
        let qrGenerado = false;
        let adminDesbloqueado = false;

        // Establece fecha mínima = hoy
        const hoy = new Date().toISOString().split('T')[0];
        document.addEventListener('DOMContentLoaded', () => {
            const inputFecha = document.getElementById('fecha');
            if (inputFecha) inputFecha.min = hoy;
        });

        // Estado de autenticación
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const doc = await db.collection("usuarios").doc(user.uid).get();
                userData = doc.data();
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('float-btns').classList.remove('hidden');
                document.getElementById('user-display-name').innerText = `${userData.nombre} ${userData.apellido}`;

                // Generar QR solo una vez
                if (!qrGenerado) {
                    new QRCode(document.getElementById("qrcode"), {
                        text: window.location.href,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff"
                    });
                    qrGenerado = true;
                }
            } else {
                document.getElementById('view-auth').classList.remove('hidden');
                document.getElementById('view-app').classList.add('hidden');
                document.getElementById('float-btns').classList.add('hidden');
            }
        });

        function toggleAuth(type) {
            document.getElementById('form-login').classList.toggle('hidden', type === 'reg');
            document.getElementById('form-reg').classList.toggle('hidden', type === 'login');
        }

        async function registrar() {
            const nom   = document.getElementById('reg-nom').value.trim();
            const ape   = document.getElementById('reg-ape').value.trim();
            const tel   = document.getElementById('reg-tel').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const pass  = document.getElementById('reg-pass').value;

            if (!nom || !ape || !tel || !email || !pass) {
                alert("Por favor completá todos los campos.");
                return;
            }
            if (pass.length < 6) {
                alert("La contraseña debe tener al menos 6 caracteres.");
                return;
            }
            try {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection("usuarios").doc(res.user.uid).set({ nombre: nom, apellido: ape, telefono: tel, email });
            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value.trim();
            const pass  = document.getElementById('login-pass').value;
            if (!email || !pass) {
                alert("Ingresá tu email y contraseña.");
                return;
            }
            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch(e) {
                alert("Usuario o clave incorrecta.");
            }
        }

        function logout() {
            auth.signOut();
            location.reload();
        }

        function irAlPaso(num) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            if (num === 'success') {
                document.getElementById('step-success').classList.remove('hidden');
            } else {
                document.getElementById(`step-${num}`).classList.remove('hidden');
            }
            if (num === 2) cargarHoras();
        }

        async function cargarHoras() {
            const fecha = document.getElementById('fecha').value;
            const grid  = document.getElementById('grid-horarios');
            grid.innerHTML = "<p class='col-span-3 text-zinc-500 text-center animate-pulse'>Consultando disponibilidad...</p>";

            const snap    = await db.collection("citas").where("fecha", "==", fecha).get();
            const ocupadas = snap.docs.map(doc => doc.data().hora);

            grid.innerHTML = "";
            horasBase.forEach(h => {
                const btn = document.createElement('button');
                btn.innerText = h;
                const estaOcup = ocupadas.includes(h);
                btn.className = estaOcup
                    ? "bg-zinc-950 text-zinc-800 p-5 rounded-3xl opacity-20 cursor-not-allowed"
                    : "bg-zinc-900 p-5 rounded-3xl border border-zinc-800 hover:border-yellow-500 font-bold transition-all active:scale-95";
                btn.disabled = estaOcup;
                if (!estaOcup) btn.onclick = () => confirmarCita(h, fecha);
                grid.appendChild(btn);
            });
        }

        async function confirmarCita(hora, fecha) {
            if (!confirm(`¿Agendar para el ${fecha} a las ${hora}?`)) return;
            await db.collection("citas").add({
                fecha, hora,
                nombre: userData.nombre,
                apellido: userData.apellido,
                tel: userData.telefono,
                uid: auth.currentUser.uid,
                creado: new Date()
            });
            document.getElementById('resumen-final').innerText = `${fecha}  @  ${hora}`;
            irAlPaso('success');
        }

        // ===== QR =====
        function toggleQR() {
            document.getElementById('qrModal').classList.toggle('hidden');
        }

        // ===== ADMIN PANEL =====
        async function accesoAdmin() {
            if (!adminDesbloqueado) {
                const pin = prompt("Ingresá el PIN de administrador:");
                if (pin === null) return; // canceló
                if (pin !== "1234") {
                    alert("PIN incorrecto.");
                    return;
                }
                adminDesbloqueado = true;
            }
            document.getElementById('adminModal').classList.remove('hidden');
            await cargarAdmin();
        }

        function toggleAdmin() {
            document.getElementById('adminModal').classList.add('hidden');
        }

        async function cargarAdmin() {
            const container = document.getElementById('admin-citas');
            const totalEl   = document.getElementById('admin-total');
            container.innerHTML = "<p class='text-zinc-500 text-center animate-pulse py-4'>Cargando citas...</p>";
            totalEl.innerText = "...";

            try {
                const snap = await db.collection("citas").orderBy("creado", "desc").get();
                totalEl.innerText = snap.size;

                if (snap.empty) {
                    container.innerHTML = "<p class='text-zinc-600 text-center py-6'>No hay citas registradas.</p>";
                    return;
                }

                container.innerHTML = "";
                snap.docs.forEach(doc => {
                    const c   = doc.data();
                    const div = document.createElement('div');
                    div.className = "bg-zinc-800 p-4 rounded-2xl border border-zinc-700 flex justify-between items-center gap-3";
                    div.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="font-black text-sm truncate">${c.nombre} ${c.apellido}</p>
                            <p class="text-yellow-500 text-xs font-bold">${c.fecha} &nbsp;@&nbsp; ${c.hora}</p>
                            <p class="text-zinc-500 text-xs mt-0.5">${c.tel || '—'}</p>
                        </div>
                        <button onclick="eliminarCita('${doc.id}')"
                            class="flex-shrink-0 bg-red-900/40 text-red-400 text-xs px-3 py-2 rounded-xl font-bold hover:bg-red-900/70 transition-colors">
                            Eliminar
                        </button>`;
                    container.appendChild(div);
                });
            } catch(e) {
                container.innerHTML = "<p class='text-red-500 text-center py-4'>Error al cargar citas.</p>";
            }
        }

        async function eliminarCita(id) {
            if (!confirm("¿Seguro que querés eliminar esta cita?")) return;
            await db.collection("citas").doc(id).delete();
            await cargarAdmin();
        }
    </script>
</body>
</html>